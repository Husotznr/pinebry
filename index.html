<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PineBry</title>
    
    <link rel="icon" href="kartanesi.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-pink: #dcb5c5;
            --card-bg: rgba(255, 255, 255, 0.98);
            --christmas-red: #d42426;
            --christmas-green: #0e4d2d; 
            --text-main: #4a4a4a;
            --accent: #ffb7b2;
            --input-bg: #f0f2f5;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }

        @keyframes snow { 0% { background-position: 0px 0px, 0px 0px, 0px 0px; } 100% { background-position: 500px 1000px, 400px 400px, 300px 300px; } }

        body {
            background-color: var(--bg-pink); color: var(--text-main); overflow-x: hidden;
            background-image: radial-gradient(rgba(255,255,255,0.9) 2px, transparent 4px), radial-gradient(rgba(255,255,255,0.7) 3px, transparent 6px), radial-gradient(rgba(255,255,255,0.5) 4px, transparent 8px);
            background-size: 500px 500px, 400px 400px, 300px 300px;
            animation: snow 20s linear infinite; padding-bottom: 80px;
        }

        /* --- LOGIN MODAL --- */
        #loginOverlay, #adminOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(147, 112, 126, 0.35);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        .login-card, .admin-card {
            background: rgba(255, 255, 255, 0.95); padding: 2rem; border-radius: 20px; width: 90%; max-width: 350px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); text-align: center; border: 1px solid rgba(255,255,255,0.6);
            max-height: 80vh; overflow-y: auto;
        }
        .login-card h2, .admin-card h2 { color: var(--christmas-red); margin-bottom: 1.5rem; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; background: var(--input-bg); }
        
        .password-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .password-wrapper input { margin-bottom: 0; padding-right: 40px; }
        .password-toggle-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            color: #888; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .password-toggle-icon:hover { color: var(--christmas-red); }

        .login-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--christmas-red); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .toggle-auth { margin-top: 15px; font-size: 0.9rem; color: #666; cursor: pointer; text-decoration: underline; }

        .user-list-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .user-list-item img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .user-list-item span { font-weight: bold; font-size: 0.9rem; }

        .app-header { text-align: center; padding: 20px 0 10px 0; position: sticky; top: 0; z-index: 99; background: linear-gradient(to bottom, var(--bg-pink) 80%, transparent); }
        .logo { color: var(--christmas-red); font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; text-shadow: 0 2px 10px rgba(255,255,255,0.5); cursor: pointer; }

        .container { 
            width: 100%; max-width: 1000px; margin: 0 auto; padding: 0 15px; 
            display: grid; grid-template-columns: 240px 1fr; gap: 25px; align-items: start;
        }

        .sidebar-wrapper { position: sticky; top: 20px; display: flex; flex-direction: column; gap: 15px; }

        .profile-card { background: var(--card-bg); padding: 15px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid white; }
        .profile-pic-container { width: 65px; height: 65px; margin: 0 auto 8px auto; position: relative; cursor: pointer; }
        .profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .profile-pic-overlay { position: absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; color: white; opacity: 0; transition: 0.2s; }
        .profile-pic-container:hover .profile-pic-overlay { opacity: 1; }
        .profile-name { font-size: 1rem; font-weight: 700; color: var(--christmas-red); margin-bottom: 8px; }
        .profile-stats { display: flex; justify-content: center; gap: 10px; background: var(--input-bg); padding: 6px; border-radius: 12px; font-size: 0.75rem; margin-bottom: 10px; }
        .stat-num { font-weight: bold; color: var(--text-main); font-size: 0.9rem; display: block; }
        
        .action-btn-group { display: flex; flex-direction: column; gap: 5px; }
        .logout-btn { background: #eee; border: none; padding: 6px 15px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; width: 100%; color: #555; }
        .admin-btn { background: var(--christmas-red); color: white; border: none; padding: 6px 15px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; width: 100%; margin-bottom: 5px; }

        .category-list { background: var(--card-bg); padding: 15px; border-radius: 20px; list-style: none; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .cat-item { padding: 10px; cursor: pointer; border-bottom: 1px dashed #ddd; display: flex; justify-content: space-between; transition: 0.2s; font-weight: 500; color: #555; }
        .cat-item:last-child { border-bottom: none; }
        .cat-item:hover, .cat-item.active { color: var(--christmas-red); padding-left: 5px; }
        .cat-count { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }

        #feedArea { display: flex; flex-direction: column; gap: 30px; }

        .create-post { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .guest-alert-box { text-align: center; padding: 10px; }
        .guest-text { font-size: 1.1rem; color: #666; margin-bottom: 15px; font-weight: 600; }
        .guest-btn { background: var(--christmas-red); color: white; border: none; padding: 10px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 10px rgba(212, 36, 38, 0.2); transition: 0.2s; }
        .guest-btn:hover { transform: scale(1.05); }

        .create-header { font-size: 0.95rem; font-weight: 700; color: #555; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .create-post textarea { width: 100%; height: 90px; border: none; border-radius: 15px; padding: 15px; resize: none; background: var(--input-bg); font-size: 0.95rem; outline: none; transition: 0.2s; }
        .create-post textarea:focus { background: white; box-shadow: 0 0 0 2px var(--accent); }
        .post-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .tools-left { display: flex; gap: 10px; align-items: center; }
        #postCategorySelect { border:none; background:var(--input-bg); padding:8px 15px; border-radius:25px; color:#555; outline:none; font-weight:600; font-size: 0.9rem; cursor: pointer; }
        
        .anon-label { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: #666; cursor: pointer; background: var(--input-bg); padding: 8px 12px; border-radius: 25px; }
        .anon-label input { cursor: pointer; accent-color: var(--christmas-red); }

        .tool-btn { background: var(--input-bg); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; }
        .btn-publish { background: var(--christmas-green); color: white; border: none; padding: 8px 25px; border-radius: 25px; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
        .file-status { font-size: 0.75rem; color: var(--christmas-green); margin-left: 5px; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }

        .post-card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); animation: fadeIn 0.4s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .post-header { display: flex; align-items: center; margin-bottom: 15px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 1px solid #eee; }
        .user-info h4 { font-size: 1rem; margin-bottom: 3px; color: #333; }
        .user-info span { font-size: 0.8rem; color: #999; display: flex; align-items: center; gap: 6px; }
        .post-cat-badge { color: white; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; }

        .post-content { 
            font-size: 1rem; line-height: 1.6; color: #333; white-space: pre-wrap; margin-bottom: 10px; 
            width: 100%; display: block; border: 1px solid transparent; padding: 0; background: transparent;
        }
        .post-content[contenteditable="true"] { outline: none; } 

        .inline-edit-actions { text-align: right; margin-top: 5px; display: none; }
        .btn-mini { padding: 5px 12px; border-radius: 12px; border: none; font-size: 0.8rem; cursor: pointer; margin-left: 5px; font-weight: 600; }
        .btn-save { background: var(--christmas-green); color: white; }
        .btn-cancel { background: #ddd; color: #333; }

        .post-image { width: 100%; height: auto; border-radius: 15px; margin-top: 10px; max-height: 500px; object-fit: cover; }
        .video-container { position: relative; padding-bottom: 56.25%; padding-top: 30px; height: 0; overflow: hidden; border-radius: 15px; margin-top: 10px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .tags { display:none; }

        .post-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .actions { display: flex; gap: 20px; }
        .act-btn { display: flex; align-items: center; gap: 6px; color: #666; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .act-btn:hover { color: var(--christmas-red); }
        .act-btn.liked { color: var(--christmas-red); }
        .act-btn.liked i { animation: pop 0.3s ease; }
        @keyframes pop { 50% { transform: scale(1.4); } }

        .comments-wrap { margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 15px; display: none; }
        .comments-wrap.show { display: block; animation: slideDown 0.2s; }
        .comment-row { font-size: 0.9rem; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .comment-user { font-weight: bold; margin-right: 8px; color: #333; }
        .add-comment-box { display: flex; gap: 10px; margin-top: 15px; }
        .add-comment-box input { flex: 1; border: none; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; outline: none; background: white; border: 1px solid #eee; }
        .add-comment-box button { background: transparent; color: var(--christmas-red); border: none; font-weight: bold; cursor: pointer; }

        /* FOOTER SIGNATURE STYLES (GÜNCELLENDİ) */
        .app-footer { 
            position: fixed; 
            bottom: 5px; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            color: var(--text-main); 
            font-size: 0.8rem; 
            background: none; 
            z-index: 10;
            opacity: 0.6;
            pointer-events: none; /* Tıklamalar arkaya geçsin */
        }
        .creator-tag { 
            font-weight: 800; color: var(--text-main); text-decoration: none; 
            transition: all 0.3s ease; display: inline-block;
            pointer-events: auto; /* Sadece linke tıklanabilsin */
        }
        .creator-tag:hover { 
            color: var(--christmas-red); 
            text-shadow: 0 0 10px rgba(212, 36, 38, 0.8), 0 0 20px rgba(255, 183, 178, 0.6); 
            transform: scale(1.1);
        }

        .decoration { position: fixed; z-index: -1; opacity: 0.5; pointer-events: none; }
        .tree-left { top: 10%; left: 2%; font-size: 6rem; color: #0e4d2d; }
        .tree-right { bottom: 10%; right: 2%; font-size: 8rem; color: #0e4d2d; }

        .gift-box { position: fixed; z-index: -1; opacity: 0.6; pointer-events: none; color: var(--christmas-red); font-size: 3rem; }
        .gift-box.one { bottom: 5%; left: 8%; color: var(--christmas-red); font-size: 3.5rem; }
        .gift-box.two { bottom: 12%; left: 4%; color: #ffc107; font-size: 2.5rem; transform: rotate(-15deg); }
        .gift-box.three { bottom: 8%; right: 12%; color: #2f5a2f; font-size: 3rem; transform: rotate(10deg); }
        .gift-box.four { bottom: 15%; right: 6%; color: var(--accent); font-size: 2.8rem; }

        @media (max-width: 768px) {
            .decoration, .gift-box { display: none; }
            .container { grid-template-columns: 1fr; }
            .sidebar-wrapper { display: none; } 
        }
    </style>
</head>
<body>

    <div id="loginOverlay" style="display:none;">
        <div class="login-card" id="loginForm">
            <h2><i class="fas fa-snowflake"></i> PineBry</h2>
            <input type="text" id="loginUser" class="login-input" placeholder="Kullanıcı Adı">
            <div class="password-wrapper">
                <input type="password" id="loginPass" class="login-input" placeholder="Şifre">
                <i class="fas fa-eye password-toggle-icon" onclick="togglePassword('loginPass', this)"></i>
            </div>
            <button class="login-btn" onclick="login()">Giriş Yap</button>
            <div class="toggle-auth" onclick="toggleAuth('register')">Hesabın yok mu? Kayıt Ol</div>
            <div style="margin-top:10px; font-size:0.8rem; cursor:pointer;" onclick="document.getElementById('loginOverlay').style.display='none'">Kapat (Misafir Modu)</div>
        </div>

        <div class="login-card" id="registerForm" style="display:none;">
            <h2>Kayıt Ol</h2>
            <input type="text" id="regUser" class="login-input" placeholder="Kullanıcı Adı Seç">
            <div class="password-wrapper">
                <input type="password" id="regPass" class="login-input" placeholder="Şifre Belirle (Min 8 Karakter)">
                <i class="fas fa-eye password-toggle-icon" onclick="togglePassword('regPass', this)"></i>
            </div>
            <button class="login-btn" onclick="register()">Kayıt Ol</button>
            <div class="toggle-auth" onclick="toggleAuth('login')">Zaten hesabın var mı? Giriş Yap</div>
            <div style="margin-top:10px; font-size:0.8rem; cursor:pointer;" onclick="document.getElementById('loginOverlay').style.display='none'">Kapat (Misafir Modu)</div>
        </div>
    </div>

    <div id="adminOverlay" style="display:none;">
        <div class="admin-card">
            <h2><i class="fas fa-users"></i> Kullanıcılar</h2>
            <div id="adminUserList" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="login-btn" onclick="document.getElementById('adminOverlay').style.display='none'" style="background:#666;">Kapat</button>
        </div>
    </div>

    <div class="gift-box one"><i class="fas fa-gift"></i></div>
    <div class="gift-box two"><i class="fas fa-gift"></i></div>
    <div class="gift-box three"><i class="fas fa-gift"></i></div>
    <div class="gift-box four"><i class="fas fa-gift"></i></div>
    <div class="decoration tree-left"><i class="fas fa-tree"></i></div>
    <div class="decoration tree-right"><i class="fas fa-tree"></i></div>

    <header class="app-header">
        <div class="logo" onclick="filterPosts('all')">
            <i class="fas fa-snowflake"></i> PineBry
        </div>
    </header>

    <div class="container">
        
        <aside class="sidebar-wrapper">
            <div class="profile-card" id="profileCard" style="display:none;">
                <label class="profile-pic-container">
                    <img src="" id="sidebarAvatar" class="profile-pic">
                    <div class="profile-pic-overlay"><i class="fas fa-camera"></i></div>
                    <input type="file" id="avatarInput" style="display:none;" accept="image/*" onchange="changeAvatar()">
                </label>
                <div class="profile-name" id="sidebarName">Kullanıcı</div>
                <div class="profile-stats">
                    <div class="stat-box"><span class="stat-num" id="statPosts">0</span><span>Konu</span></div>
                    <div class="stat-box"><span class="stat-num" id="statComments">0</span><span>Mesaj</span></div>
                </div>
                <div class="action-btn-group">
                    <button id="adminBtn" class="admin-btn" style="display:none;" onclick="showAdminPanel()"><i class="fas fa-shield-alt"></i> Kullanıcılar</button>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Çıkış</button>
                </div>
            </div>
            <ul class="category-list" id="categoryContainer"></ul>
        </aside>

        <main>
            <div class="create-post" id="createPostContainer"></div>
            <div id="feedArea"></div>
        </main>
    </div>

    <footer class="app-footer">
        Made by <a href="#" class="creator-tag">@hsyntznr</a>
    </footer>

    <script>
        // --- 1. FIREBASE AYARLARI ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVchO8yTY0ghRvtvhOLfIvqDvR1zygXn8",
            authDomain: "pinebry-47e50.firebaseapp.com",
            databaseURL: "https://pinebry-47e50-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pinebry-47e50",
            storageBucket: "pinebry-47e50.firebasestorage.app",
            messagingSenderId: "49054352708",
            appId: "1:49054352708:web:0b555452006df55e6d4311",
            measurementId: "G-B3J4T3D264"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let currentFilter = 'all';
        let allPosts = [];

        // KATEGORİLER
        const categories = [
            { id: 'all', name: 'Tümü', color: '#666' },
            { id: 'manga-anime', name: 'Anime', color: '#ff9ff3' },
            { id: 'filmler-diziler', name: 'Film&Dizi', color: '#54a0ff' },
            { id: 'muzik', name: 'Müzik', color: '#1dd1a1' },
            { id: 'kitaplar-edebiyat', name: 'Kitap', color: '#ff9f43' }
        ];

        window.onload = function() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('loginOverlay').style.display = 'none';
                    db.ref('users/' + user.uid).once('value').then((snapshot) => {
                        const userData = snapshot.val();
                        currentUser = {
                            uid: user.uid,
                            username: userData ? userData.username : user.email.split('@')[0],
                            avatar: userData ? userData.avatar : "https://ui-avatars.com/api/?name=" + user.email + "&background=random",
                            isAdmin: false
                        };
                        // Admin Kontrolü
                        if(currentUser.username === "admin") currentUser.isAdmin = true;
                        
                        try {
                            localStorage.setItem('pb_currentUser', JSON.stringify(currentUser));
                        } catch (e) { console.warn("Lokal hafıza dolu."); }
                        
                        checkAuthUI();
                    });
                } else {
                    currentUser = null;
                    document.getElementById('loginOverlay').style.display = 'flex';
                    checkAuthUI();
                }
            });

            // Postları Dinle
            db.ref('posts').on('value', (snapshot) => {
                const data = snapshot.val();
                allPosts = [];
                if (data) {
                    Object.keys(data).forEach(key => {
                        allPosts.unshift({ id: key, ...data[key] });
                    });
                }
                renderCategories();
                renderFeed(currentFilter);
            });
        };

        // --- YARDIMCI FONKSİYON: RESİM KÜÇÜLTME ---
        // Bu fonksiyon büyük resimleri alır, tarayıcıda küçültür ve hızlıca yükler.
        function resizeImage(file, maxWidth, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Resmi JPEG formatında ve 0.7 kalitesinde sıkıştır
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- AUTH & UI ---
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if(input.type === "password") {
                input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
            }
        }

        function checkAuthUI() {
            const createContainer = document.getElementById('createPostContainer');
            const profileCard = document.getElementById('profileCard');
            const adminBtn = document.getElementById('adminBtn');

            if (currentUser) {
                profileCard.style.display = 'block';
                if(currentUser.isAdmin && adminBtn) adminBtn.style.display = 'block';
                else if(adminBtn) adminBtn.style.display = 'none';

                updateProfileUI();
                createContainer.innerHTML = `
                    <div class="create-header"><i class="fas fa-pen-fancy" style="color:var(--christmas-red);"></i> Bir şeyler yaz...</div>
                    <textarea id="postContent" placeholder="Bugün nelerden bahsetmek istersin?"></textarea>
                    <div class="post-tools">
                        <div class="tools-left">
                            <select id="postCategorySelect">
                                <option value="manga-anime">Anime</option>
                                <option value="filmler-diziler">Film/Dizi</option>
                                <option value="muzik">Müzik</option>
                                <option value="kitaplar-edebiyat">Kitap</option>
                            </select>
                            <label class="anon-label"><input type="checkbox" id="anonCheck"> Anonim</label>
                            <label class="tool-btn"><i class="fas fa-image"></i><input type="file" id="imageInput" style="display: none;" accept="image/*"></label>
                            <span id="fileNameDisplay" class="file-status"></span>
                        </div>
                        <button class="btn-publish" onclick="addPost()">Paylaş</button>
                    </div>`;
                
                setTimeout(() => {
                    const imgInput = document.getElementById('imageInput');
                    if(imgInput) {
                        imgInput.addEventListener('change', function() {
                            const fileName = this.files[0] ? this.files[0].name : '';
                            const display = document.getElementById('fileNameDisplay');
                            if(display) display.textContent = fileName ? `${fileName} eklendi` : '';
                        });
                    }
                }, 500);

            } else {
                profileCard.style.display = 'none';
                createContainer.innerHTML = `
                    <div class="guest-alert-box">
                        <div class="guest-text">Konu oluşturmak için giriş yapın ✨</div>
                        <button class="guest-btn" onclick="document.getElementById('loginOverlay').style.display='flex'">Giriş Yap</button>
                    </div>`;
            }
        }

        function toggleAuth(type) {
            document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = type === 'register' ? 'block' : 'none';
        }

        function register() {
            const u = document.getElementById('regUser').value.trim();
            const p = document.getElementById('regPass').value.trim();
            if(!u || !p) return alert("Bilgileri doldur!");
            if(p.length < 8) return alert("Şifre en az 8 karakter!");
            const email = u + "@pinebry.app"; 
            auth.createUserWithEmailAndPassword(email, p)
                .then((userCredential) => {
                    const user = userCredential.user;
                    db.ref('users/' + user.uid).set({
                        username: u,
                        avatar: `https://ui-avatars.com/api/?name=${u}&background=random`
                    });
                    alert("Kayıt başarılı!");
                    toggleAuth('login');
                })
                .catch((error) => { alert(error.message); });
        }

        function login() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const email = u + "@pinebry.app"; 
            auth.signInWithEmailAndPassword(email, p).catch((error) => { alert("Hata: " + error.message); });
        }

        function logout() { auth.signOut(); }

        function updateProfileUI() {
            if(!currentUser) return;
            const sName = document.getElementById('sidebarName');
            const sAvatar = document.getElementById('sidebarAvatar');
            if(sName) sName.textContent = currentUser.username;
            if(sAvatar) sAvatar.src = currentUser.avatar;
            
            const postCount = allPosts.filter(p => p.uid === currentUser.uid).length;
            const pCountEl = document.getElementById('statPosts');
            if(pCountEl) pCountEl.textContent = postCount;
        }

        // --- GÜNCELLENEN AVATAR DEĞİŞTİRME (RESİZER EKLENDİ) ---
        function changeAvatar() {
            const file = document.getElementById('avatarInput').files[0];
            if(file) {
                // Resizer kullanılıyor: Profil için max genişlik 200px yeterli
                resizeImage(file, 200, function(resizedDataUrl) {
                    db.ref('users/' + currentUser.uid).update({ avatar: resizedDataUrl })
                    .then(() => {
                        currentUser.avatar = resizedDataUrl;
                        try { localStorage.setItem('pb_currentUser', JSON.stringify(currentUser)); } catch(e){}
                        updateProfileUI();
                        renderFeed(currentFilter);
                    })
                    .catch((err) => { alert("Hata: " + err.message); });
                });
            }
        }

        // --- POST İŞLEMLERİ ---
        function addPost() {
            if(!currentUser) { alert("Giriş yapmalısın!"); return; }

            const content = document.getElementById('postContent').value;
            const catSelect = document.getElementById('postCategorySelect');
            const fileInput = document.getElementById('imageInput');
            const isAnon = document.getElementById('anonCheck').checked;

            if (!content.trim()) { alert("Lütfen bir şeyler yaz!"); return; }
            
            // Eğer resim seçildiyse onu da küçültüp gönderelim (Max 800px)
            if (fileInput.files && fileInput.files[0]) {
                resizeImage(fileInput.files[0], 800, function(resizedImgUrl) {
                    sendPostToDB(content, catSelect, resizedImgUrl, isAnon);
                });
            } else {
                sendPostToDB(content, catSelect, null, isAnon);
            }
        }

        function sendPostToDB(content, catSelect, imgUrl, isAnon) {
            const now = new Date();
            const timeStr = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});
            
            // Avatar kontrolü (Çok büyükse varsayılan kullan ki sistemi tıkamasın)
            let safeAvatar = currentUser.avatar;
            if (!safeAvatar || safeAvatar.length > 100000) { 
                 // Eğer avatar hala çok büyükse (eski yüklemelerden), ui-avatars kullan
                 // safeAvatar = "https://ui-avatars.com/api/?name=" + currentUser.username;
                 // Not: Resize ile artık büyük olmayacak ama önlem iyidir.
            }

            const newPost = {
                uid: currentUser.uid, 
                author: currentUser.username, 
                avatar: safeAvatar,
                isAnonymous: isAnon, 
                category: catSelect.value, 
                categoryName: catSelect.options[catSelect.selectedIndex].text,
                content: content, 
                image: imgUrl, 
                tags: [], 
                kudos: 0, 
                time: timeStr
            };

            db.ref('posts').push(newPost)
            .then(() => {
                document.getElementById('postContent').value = '';
                const fDisplay = document.getElementById('fileNameDisplay');
                if(fDisplay) fDisplay.textContent = '';
                document.getElementById('imageInput').value = '';
                document.getElementById('anonCheck').checked = false;
            })
            .catch((error) => {
                alert("Mesaj gönderilemedi: " + error.message);
            });
        }

        function toggleLike(id) {
            if(!currentUser) return alert("Giriş yapmalısın!");
            const uid = currentUser.uid;
            const postRef = db.ref('posts/' + id);
            postRef.transaction((post) => {
                if (post) {
                    if (post.likes && post.likes[uid]) {
                        post.kudos = (post.kudos || 1) - 1;
                        post.likes[uid] = null;
                    } else {
                        post.kudos = (post.kudos || 0) + 1;
                        if (!post.likes) post.likes = {};
                        post.likes[uid] = true;
                    }
                }
                return post;
            });
        }

        function toggleComments(elemId) {
            const el = document.getElementById(elemId);
            if(el) el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        function addComment(id) {
            if(!currentUser) return alert("Giriş yapmalısın!");
            const val = document.getElementById(`c-input-${id}`).value;
            if(val.trim()){ 
                db.ref('posts/' + id + '/comments').push({
                    user: currentUser.username,
                    text: val
                });
            }
        }

        function editPost(id) {
            const contentDiv = document.getElementById(`content-${id}`);
            const btnGroup = document.getElementById(`btn-group-${id}`);
            const post = allPosts.find(p => p.id === id);
            
            if(post) {
                contentDiv.innerText = post.content; 
                contentDiv.contentEditable = "true"; 
                contentDiv.focus();
                if(btnGroup) btnGroup.style.display = 'block';
            }
        }

        function savePost(id) {
            const contentDiv = document.getElementById(`content-${id}`);
            db.ref('posts/' + id).update({ content: contentDiv.innerText });
        }

        function cancelEdit() { renderFeed(currentFilter); }
        function deletePost(id) { if(confirm("Siliniyor?")) { db.ref('posts/' + id).remove(); } }

        function showAdminPanel() {
            const listDiv = document.getElementById('adminUserList');
            if(!listDiv) return;
            
            listDiv.innerHTML = "Yükleniyor...";
            document.getElementById('adminOverlay').style.display = 'flex';
            
            db.ref('users').once('value').then(snapshot => {
                const users = snapshot.val();
                listDiv.innerHTML = "";
                if(users) {
                    Object.values(users).forEach(u => {
                        let safeImg = u.avatar && u.avatar.length < 5000000 ? u.avatar : "https://ui-avatars.com/api/?name=" + u.username;
                        listDiv.insertAdjacentHTML('beforeend', `<div class="user-list-item"><img src="${safeImg}"><span>${u.username}</span></div>`);
                    });
                } else { listDiv.innerHTML = "Kullanıcı yok."; }
            });
        }

        // --- RENDER ---
        function formatContent(text) {
            if(!text) return "";
            let formatted = text.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
            const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w\-]+)(?:\S+)?/g;
            formatted = formatted.replace(ytRegex, '<div class="video-container"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
            const spotifyRegex = /(?:https?:\/\/)?(?:open\.spotify\.com\/)(track|album|playlist)\/([a-zA-Z0-9]+)(?:\?\S+)?/g;
            formatted = formatted.replace(spotifyRegex, '<iframe style="border-radius:12px; margin-top:10px;" src="https://open.spotify.com/embed/$1/$2" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>');
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }

        function renderCategories() {
            const container = document.getElementById('categoryContainer');
            if(!container) return;
            container.innerHTML = '';
            categories.forEach(cat => {
                let count = (cat.id === 'all') ? allPosts.length : allPosts.filter(p => p.category === cat.id).length;
                const countHTML = count > 0 ? `<span class="cat-count">${count}</span>` : '';
                const activeClass = currentFilter === cat.id ? 'active' : '';
                container.insertAdjacentHTML('beforeend', `<li class="cat-item ${activeClass}" onclick="filterPosts('${cat.id}')">${cat.name}${countHTML}</li>`);
            });
        }

        function renderFeed(filterCategory) {
            currentFilter = filterCategory;
            renderCategories(); 
            const feedArea = document.getElementById('feedArea');
            if(!feedArea) return;
            feedArea.innerHTML = "";
            
            const filteredPosts = filterCategory === 'all' ? allPosts : allPosts.filter(p => p.category === filterCategory);

            if (filteredPosts.length === 0) { feedArea.innerHTML = `<div style="text-align:center; color:#888;">Henüz gönderi yok.</div>`; return; }

            filteredPosts.forEach(post => {
                const isOwner = currentUser && (post.uid === currentUser.uid || currentUser.isAdmin);
                const adminBtns = isOwner ? `
                    <div style="margin-left:auto; display:flex; gap:15px;">
                        <i class="fas fa-pen" style="color:#f39c12; cursor:pointer;" onclick="editPost('${post.id}')"></i>
                        <i class="fas fa-trash" style="color:#e74c3c; cursor:pointer;" onclick="deletePost('${post.id}')"></i>
                    </div>` : '';

                let displayName = post.author;
                let displayAvatar = post.avatar;

                if(post.isAnonymous) {
                    displayName = "Anonim";
                    displayAvatar = "data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs="; 
                }

                const catInfo = categories.find(c => c.id === post.category);
                const badgeColor = catInfo ? catInfo.color : '#666';
                const isLiked = currentUser && post.likes && post.likes[currentUser.uid];

                let commentsHtml = '';
                if (post.comments) {
                    Object.values(post.comments).forEach(c => {
                        commentsHtml += `<div class="comment-row"><span class="comment-user">${c.user}</span>${c.text}</div>`;
                    });
                }

                const postHTML = `
                <article class="post-card">
                    <div class="post-header">
                        <img src="${displayAvatar}" class="avatar" style="${post.isAnonymous ? 'border:1px solid #000' : ''}">
                        <div class="user-info"><h4>${displayName}</h4><span><span class="post-cat-badge" style="background:${badgeColor}">${post.categoryName}</span> • ${post.time}</span></div>
                    </div>
                    
                    <div id="content-${post.id}" class="post-content">${formatContent(post.content)}</div>
                    
                    <div id="btn-group-${post.id}" class="inline-edit-actions">
                        <button class="btn-mini btn-cancel" onclick="cancelEdit()">İptal</button>
                        <button class="btn-mini btn-save" onclick="savePost('${post.id}')">Kaydet</button>
                    </div>

                    ${post.image ? `<img src="${post.image}" class="post-image">` : ''}
                    
                    <div class="post-footer">
                        <div class="actions">
                            <div class="act-btn" onclick="toggleLike('${post.id}')">
                                <i class="${isLiked ? 'fas' : 'far'} fa-heart" style="color:${isLiked ? 'var(--christmas-red)' : '#666'}"></i> ${post.kudos || 0}
                            </div>
                            <div class="act-btn" onclick="toggleComments('comment-wrap-${post.id}')">
                                <i class="far fa-comment-alt"></i> ${post.comments ? Object.keys(post.comments).length : 0}
                            </div>
                        </div>
                        ${adminBtns}
                    </div>
                    
                    <div id="comment-wrap-${post.id}" class="comments-wrap">
                        ${commentsHtml}
                        <div class="add-comment-box"><input type="text" id="c-input-${post.id}" placeholder="Yorum ekle..."><button onclick="addComment('${post.id}')">Yolla</button></div>
                    </div>
                </article>`;
                feedArea.insertAdjacentHTML('beforeend', postHTML); 
            });
        }

        function filterPosts(cat) { renderFeed(cat); }
    </script>
</body>
</html>

